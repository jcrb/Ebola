---
title: "EVB par pays"
author: "JcB"
date: "10/07/2014"
output: html_document
---

Suivi de l'épidémie de fièvre EBOLA en 2014
===========================================

source: [promed mail](http://www.promedmail.org) et [OMS](http://who.int/csr/don/2014_07_15_ebola/en/)

[OMS en français](http://who.int/csr/don/archive/disease/ebola/fr/)

[OMS en anglais](http://who.int/csr/don/archive/disease/ebola/en/)

Le 7/8/2014 les donnée sont saisies dans un document partagé sur drive (Ebola). Le fichier _EBOLA 2014 - Pays.csv_ remplace le fichier _EVB_pays.csv_. Idem pour newcases.csv. Dans le document RPU_xml on trouvera une méthode pour importer le tableau de l'OMS via R.

Les données sont colligées dans __EVB_PromedMail.ods__ puis réenregistrées au format .csv dans __EVB_pays.csv__.

```{r init, echo=FALSE, comment=""}
library(knitr)
library(xts)
source("~/Documents/Resural/Stat Resural/RPU_2013/Routines/mes_fonctions.R")

#file <- "EVB_pays.csv"
file <- "EBOLA 2014 - Pays.csv" # fichier issu de drive
d <- read.csv(file, header = TRUE)
d$Date <- as.Date(d$Date)
names(d)
str(d)
```
Sommes par pays
---------------

- __dcd__ nombre total de décès
- __cas__ nombre total de cas
- __cfr__ mortalité globale (en %)
- __cas.g__ total des cas en Guinée
- __dcd.g__ total des décès en Guinée
- __cfr.g__ mortalité en Guinée
- __cas.sl__
- __dcd.sl__
- __ cfr.sl__
- __cas.lb__
- __dcd.lb__
- __cfr.lb__
```{r calculs, echo=FALSE}
sum(d$Total[d$Date == max(d$Date)])
sum(d$Death[d$Date == max(d$Date)])

dcd <- sum(d$Death[d$Date == max(d$Date)])
cas <- sum(d$Total[d$Date == max(d$Date)])
cfr <- round(dcd * 100 / cas, 2)

cas.g <- d$Total[d$Pays == "Guinea" & d$Date == max(d$Date)]
dcd.g <- d$Death[d$Pays == "Guinea" & d$Date == max(d$Date)]
cfr.g <- round(dcd.g * 100 / cas.g, 2)

cas.sl <- d$Total[d$Pays == "Sierra Leone" & d$Date == max(d$Date)]
dcd.sl <- d$Death[d$Pays == "Sierra Leone" & d$Date == max(d$Date)]
cfr.sl <- round(dcd.sl * 100 / cas.sl, 2)

cas.lb <- d$Total[d$Pays == "Liberia" & d$Date == max(d$Date)]
dcd.lb <- d$Death[d$Pays == "Liberia" & d$Date == max(d$Date)]
cfr.lb <- round(dcd.lb * 100 / cas.lb, 2)

cas.ng <- d$Total[d$Pays == "Nigéria" & d$Date == max(d$Date)]
dcd.ng <- d$Death[d$Pays == "Nigéria" & d$Date == max(d$Date)]
cfr.ng <- round(dcd.ng * 100 / cas.ng, 2)

a <- cbind(cas, cas.g, cas.sl, cas.lb, cas.ng)
b <- cbind(dcd, dcd.g, dcd.sl, dcd.lb, dcd.lb)
t <- rbind(a,b)
colnames(t) <- c("Total", "Guinée", "Sierra Leone", "Libéria", "Nigéria")
rownames(t) <- c("cas", "Décès")
kable(t)

# nombre total de cas cumulatif (par pays)
max.pays <- tapply(d$Total, d$Pays, max)
max.pays

# nombre total de cas cumulatif (par date)
tot <- tapply(d$Total, d$Date, sum)
date <- unique(d$Date)
a <- data.frame(date,tot)
plot(a, main="Nombre cumulatif de cas d'Ebola", ylab="Nombre de cas", xlab="2014", type="b")
copyright(an=2014, titre="HUS-Cellule NRBCE")

b <- xts(a, order.by = date)
plot(b$tot, main="Nombre cumulatif de cas d'Ebola", ylab="Nombre de cas", xlab="2014", type="l")
copyright(an=2014, titre="HUS-Cellule NRBCE")

# uniquement en Guinée
x <- xts(d, order.by = d$Date)
plot(x$Total[x$Pays == "Guinea"], main="Cas cumulatif en Guinée", ylab="Nombre de cas")
barplot(x$Total[x$Pays == "Guinea"], main="Cas cumulatif en Guinée", ylab="Nombre de cas")
copyright(an=2014, titre="HUS-Cellule NRBCE")

# major.format permet de définir la syntaxe des dates pour l'axe des X [source](https://stat.ethz.ch/pipermail/r-help/2011-July/285360.html)
m <- par("mar")
par(mar = c(6.1, 4.1, 4.1, 2.1))
plot(x$Total[x$Pays == "Guinea"], ylim=c(0,max(max.pays)), type = "bars", main = "Nombre cumulé de cas d'Ebola", ylab="nombre de cas", las = 2, cex.axis = 0.7, major.format="%d/%m/%Y")
lines(x$Total[x$Pays == "Guinea"], ylim=c(0,450), col="red")
lines(x$Total[x$Pays == "Liberia"], ylim=c(0,450), col="blue")
lines(x$Total[x$Pays == "Sierra Leone"], ylim=c(0,450), col="green")
legend("topleft", legend = c("Guinée","Libéria","Sierra Leone"), col=c("red","blue","green"), lty=1, lwd=2)
copyright(an=2014, titre="HUS-Cellule NRBCE")
par(mar=m)

tapply(d$Total, d$Date, sum)
tapply(d$Death, d$Date, sum)

```
Dernier bilan: `r max(d$Date)`  
Nombre cumulé de cas: $`r cas`$  
Nombre cumulé de décès: $`r dcd`$  
Mortalité globale: $`r cfr`$ %   
- mortalité en Guinée: $`r cfr.g`$ %  
- mortalité au Libéria: $`r cfr.lb`$ %  
- mortalité en Sierra Leone: $`r cfr.sl`$ %  

New Cases et Courbe épidémique
==============================

```{r newcase, echo=FALSE}
library(epitools)
# file2 <- "newcases.csv"
file2 <- "EBOLA 2014 - newcases.csv" # fichier issu du drive
n2 <- read.csv(file2, header = TRUE)
n2$date <- as.Date(n2$date)
summary(n2$pays)

# On crée autant d'enregistrements qu'il y a de cas
x.date <- rep(n2$date, n2$new.case)
x.pays <- rep(n2$pays, n2$new.case)
new.case <- data.frame(x.date, x.pays)

epicurve.weeks(x.date, sunday = FALSE, main="Ebola - Nouveaux cas")
copyright(an=2014, titre="HUS-Cellule NRBCE")

col3seq.d <- c("#43A2CA", "#A8DDB5", "red", "#E0F3DB")
ebola <- epicurve.weeks(new.case$x.date, sunday = FALSE, strata = new.case$x.pays, col = col3seq.d, axisnames = FALSE, sub="D'après les données de l'OMS")
axis(1, at = ebola$xvals, labels = ebola$cweek, tick = FALSE, line = 0)
axis(1, at = ebola$xvals, labels = ebola$cmonth, tick = FALSE, line = 1)
title(main="Ebola - Nouveaux cas", ylab = "fréquence", xlab = "2014 - semaines")
legend("topleft", legend=c("Guinée", "Libéria", "Nigéria", "Sierra Leone"), col=col3seq.d, fill=col3seq.d, bty="n")
copyright(an=2014, titre="HUS-Cellule NRBCE")
```

Nouveaux cas par pays
---------------------
```{r newcase_pays,echo=FALSE}
new.case.g <- new.case[new.case$x.pays=="GUINEE",]
new.case.l <- new.case[new.case$x.pays=="LIBERIA",]
new.case.sl <- new.case[new.case$x.pays=="SIERRA-LEONE",]
new.case.na <- new.case[new.case$x.pays=="NIGERIA",]

ebola.g <- epicurve.weeks(new.case.g$x.date, sunday = FALSE, axisnames = FALSE, sub="D'après les données de l'OMS", col="#43A2CA", main="Guinée Conacry - 2014", min.date = min(new.case$x.date))
axis(1, at = ebola$xvals, labels = ebola$cweek, tick = FALSE, line = 0)
copyright(an=2014, titre="HUS-Cellule NRBCE")

ebola.l <- epicurve.weeks(new.case.l$x.date, sunday = FALSE, axisnames = FALSE, sub="D'après les données de l'OMS", col="#A8DDB5", main="Libéria - 2014", min.date = min(new.case$x.date))
axis(1, at = ebola$xvals, labels = ebola$cweek, tick = FALSE, line = 0)
copyright(an=2014, titre="HUS-Cellule NRBCE")

ebola.sl <- epicurve.weeks(new.case.sl$x.date, sunday = FALSE, axisnames = FALSE, sub="D'après les données de l'OMS", col="#E0F3DB", main="Sierra Leone - 2014", min.date = min(new.case$x.date))
axis(1, at = ebola$xvals, labels = ebola$cweek, tick = FALSE, line = 0)
copyright(an=2014, titre="HUS-Cellule NRBCE")

# grouppés

opar <- par(no.readonly=TRUE)
par(mfrow=c(3,1))

ebola.g <- epicurve.weeks(new.case.g$x.date, sunday = FALSE, axisnames = FALSE, sub="D'après les données de l'OMS", col="#43A2CA", main="Guinée Conacry - 2014", min.date = min(new.case$x.date))
axis(1, at = ebola$xvals, labels = ebola$cweek, tick = FALSE, line = 0)

ebola.l <- epicurve.weeks(new.case.l$x.date, sunday = FALSE, axisnames = FALSE, sub="D'après les données de l'OMS", col="#A8DDB5", main="Libéria - 2014", min.date = min(new.case$x.date))
axis(1, at = ebola$xvals, labels = ebola$cweek, tick = FALSE, line = 0)

ebola.sl <- epicurve.weeks(new.case.sl$x.date, sunday = FALSE, axisnames = FALSE, sub="D'après les données de l'OMS", col="#E0F3DB", main="Sierra Leone - 2014", min.date = min(new.case$x.date))
axis(1, at = ebola$xvals, labels = ebola$cweek, tick = FALSE, line = 0)

copyright(an=2014, line = 0.5)

ebola.na <- epicurve.weeks(new.case.na$x.date, sunday = FALSE, axisnames = FALSE, sub="D'après les données de l'OMS", col="red", main="Nigéria - 2014", min.date = min(new.case$x.date))
axis(1, at = ebola$xvals, labels = ebola$cweek, tick = FALSE, line = 0)

par(opar)
# copyright(an=2014, titre="HUS-Cellule NRBCE")
```

ToDo: cartographie
